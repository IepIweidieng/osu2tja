from importlib import reload
import shutil
import sys
import os
from typing import List

try:
    from . import tja2osu
except ImportError:
    import tja2osu

WATER_MARK = "//Auto generated by osu2tja"

# song data
TITLE = "NO TITLE"
SUBTITLE = "NO SUBTITLE"
BPM = "0.0" # use string copying
WAVE = ""
OFFSET = "0.0" # use string copying
DEMOSTART = "0.0" # use string copying
SONGVOL = "100.0" # use string copying
SEVOL = "100.0" # use string copying

def get_course_by_number(str_):
    if not str_.isdigit():
        return str_
    num = int(str_)
    if num <= 0: return "Easy"
    elif num == 1: return "Normal"
    elif num == 2: return "Hard"
    elif num == 3: return "Oni"
    else: return "Oni%d" % (num-3)

def get_comm_data(filename):
    assert isinstance(filename, str)
    assert filename.endswith(".tja")
    global TITLE, SUBTITLE, BPM, WAVE, OFFSET, DEMOSTART, SONGVOL, SEVOL
    try: fobj = open(filename, "rb")
    except IOError: tja2osu.rtassert(False, "can't open tja file.")
    if fobj.peek(3) == "".encode("utf-8-sig"):
        fobj.seek(3) # ignore UTF-8 BOM
    course_list = []
    for line in fobj:
        line = line.strip()
        try: i = line.index(b":")
        except ValueError: continue
        vname = line[:i].strip()
        vval = line[i+1:].strip()
        if vname == b"TITLE": TITLE = tja2osu.convert_str(vval)
        elif vname == b"SUBTITLE": SUBTITLE = tja2osu.convert_str(vval)
        elif vname == b"BPM": BPM = vval.decode("latin-1")
        elif vname == b"WAVE": WAVE = tja2osu.convert_str(vval)
        elif vname == b"OFFSET": OFFSET = vval.decode("latin-1")
        elif vname == b"DEMOSTART": DEMOSTART = vval.decode("latin-1")
        elif vname == b"SONGVOL": SONGVOL = vval.decode("latin-1")
        elif vname == b"SEVOL": SEVOL = vval.decode("latin-1")
        elif vname == b"COURSE":
            vval = get_course_by_number(vval.decode("latin-1"))
            course_list.append(vval)
    fobj.close()
    return course_list

def divide_diff(path_tja: str, dir_out: str) -> List[str]:
    assert isinstance(path_tja, str)
    fname, ext = os.path.splitext(os.path.basename(path_tja))
    assert ext == ".tja"

    course_list = get_comm_data(path_tja)
    file_list = [f"{fname} {x}.tja" for x in course_list]

    diff_data = []
    started = False
    i = 0
    fobj = open(path_tja, "rb")
    if fobj.peek(3) == "".encode("utf-8-sig"):
        fobj.seek(3) # ignore UTF-8 BOM
    for line in fobj:
        line = line.strip()
        if b"#END" in line:
            diff_data.append(line.decode("latin1"))

            if i >= len(file_list):
                course_list.append(f"No{i}")
                file_list.append(f"{fname} No{i}.tja")

            # convert to UTF-8-BOM TJA for easier encoding handling
            # only compatible with newer simulators such as TJAPlayer3 and taiko-web
            fout = open(os.path.join(dir_out, file_list[i]), "w", encoding="utf-8-sig")

            print(WATER_MARK, file=fout)
            print("TITLE:%s" % (TITLE,), file=fout)
            print("SUBTITLE:%s" % (SUBTITLE,), file=fout)
            print("BPM:%s" % (BPM,), file=fout)
            print("WAVE:%s" % (WAVE,), file=fout)
            print("OFFSET:%s" % (OFFSET,), file=fout)
            print("DEMOSTART:%s" % (DEMOSTART,), file=fout)
            print("SONGVOL:%s" % (SONGVOL,), file=fout)
            print("SEVOL:%s" % (SEVOL,), file=fout)
            print("", file=fout)
            print("COURSE:%s" % (course_list[i],), file=fout)

            for str_ in diff_data:
                print(str_, file=fout)
            fout.close()
            diff_data = []
            started = False
            i += 1
            continue

        if not started and b"#START" in line:
            started = True
        if started:
            diff_data.append(line.decode("latin1"))
    fobj.close()

    assert i == len(course_list), course_list

    return file_list

def divide_branch(path_tja: str, dir_out: str) -> List[str]:
    assert isinstance(path_tja, str)
    fname, ext = os.path.splitext(os.path.basename(path_tja))
    assert ext == ".tja"

    try:
        fobj = open(path_tja, "rb")
    except IOError:
        assert False, "can't open tja file."

    if fobj.peek(3) == "".encode("utf-8-sig"):
        fobj.seek(3) # ignore UTF-8 BOM
    branch_data = [[], [], []]
    which = None

    has_branch = False
    for line in fobj:
        line = line.strip()
        if b"#BRANCHSTART" in line:
            has_branch = True
            continue
        if b"#BRANCHEND" in line \
            or b"#SECTION" in line:
            continue
        if b"#E" in line:
            which = "E"
        elif b"#N" in line:
            which = "N"
        elif (b"#M" in line) and (b"#MEASURE" not in line):
            which = "M"
        elif b"#BRANCHEND" in line:
            which = None
        else:
            _line = line.strip()
            try: i = _line.index(b":")
            except ValueError: continue
            vname = _line[:i].strip()
            vval = _line[i+1:].strip()
            if vname == b"COURSE":
                vval_str = vval.decode("latin1")
                branch_data[0].append("COURSE:" + vval_str + "(Kurouto)")
                branch_data[1].append("COURSE:" + vval_str + "(Futsuu)")
                branch_data[2].append("COURSE:" + vval_str + "(Tatsujin)")
                continue

            line_str = line.decode("latin1")
            if which == None:
                branch_data[0].append(line_str)
                branch_data[1].append(line_str)
                branch_data[2].append(line_str)
            elif which == "E":
                branch_data[0].append(line_str)
            elif which == "N":
                branch_data[1].append(line_str)
            elif which == "M":
                branch_data[2].append(line_str)
            else:
                assert False
    fobj.close()
    if not has_branch:
        return []

    file_list = [f"{fname}(Kurouto).tja", f"{fname}(Futsuu).tja", f"{fname}(Tatsujin).tja"]
    i = 0
    for f in file_list:
        # convert to UTF-8-BOM TJA for easier encoding handling
        # only compatible with newer simulators such as TJAPlayer3 and taiko-web
        fout = open(os.path.join(dir_out, f), "w", encoding="utf-8-sig")
        print(WATER_MARK, file=fout)
        for str_ in branch_data[i]:
            print(str_, file=fout)
        fout.close()
        i += 1

    return file_list


def tja2osus(tja_path: str, target_path: str="out") -> None:
    dirname_dest, ext = os.path.splitext(os.path.basename(tja_path))
    dir_tmp = os.path.join("tmp", dirname_dest)
    os.makedirs(dir_tmp, exist_ok=True)
    all_file_list = []
    file_list = divide_diff(tja_path, dir_tmp)
    for diff_file in file_list:
        branch_file_list = divide_branch(os.path.join(dir_tmp, diff_file), dir_tmp)
        if len(branch_file_list) > 0:
            all_file_list.extend(branch_file_list)
        else:
            all_file_list.append(diff_file)

    dir_out = os.path.join(target_path, dirname_dest)
    os.makedirs(dir_out, exist_ok=True)
    old_stdout = sys.stdout
    for fname_tja in all_file_list:
        fname, ext = os.path.splitext(fname_tja)
        piece = fname.rsplit(None, 1)
        fname = piece[0] + "[" + piece[1] + "]"
        fout = open(os.path.join(dir_out, f"{fname}.osu"), "w")
        sys.stdout = fout
        module = reload(tja2osu)
        tja2osu.tja2osu(os.path.join(dir_tmp, fname_tja))
        fout.close()
        
        sys.stdout = old_stdout
        print("Generate:%s.osu" % fname, file=sys.stderr)

    try:
        path_wave_src = os.path.join(os.path.dirname(tja_path), WAVE)
        path_wave_dest = os.path.join(dir_out, WAVE)
        shutil.copyfile(path_wave_src, path_wave_dest)
    except FileNotFoundError:
        print(f"Audio file {path_wave_src} not found. Not copied.", file=sys.stderr)

if __name__ == "__main__":
    assert len(sys.argv) > 1
    tja2osus(sys.argv[1])
